<template>
<div class="dashboard-view">
<div class="view-header">
    <h1>Mis Bases de Datos</h1>
    <div style="display: flex; gap: 12px;">
        <button class="btn-debug" @click="debugAuth" title="Verificar autenticaci√≥n">üîç Debug</button>
        <button class="btn-primary" @click="openCreateModal">Crear Base de Datos</button>
    </div>
</div>

<section class="quota-section reveal-on-scroll">
    <h3>Bases de Datos</h3>
    <div class="quota-grid">
    <StatCard title="MYSQL" :value="`${countByEngine('MySQL')} / ${databaseLimit}`" subtitle="Instancias usadas" logo="/logos/mysql.svg" cardColor="#00758F" />
    <StatCard title="POSTGRESQL" :value="`${countByEngine('PostgreSQL')} / ${databaseLimit}`" subtitle="Instancias usadas" logo="/logos/postgresql.svg" cardColor="#336791" />
    <StatCard title="MONGODB" :value="`${countByEngine('MongoDB')} / ${databaseLimit}`" subtitle="Instancias usadas" logo="/logos/mongodb.svg" cardColor="#47A248" />
    <StatCard title="CASSANDRA" :value="`${countByEngine('Cassandra')} / ${databaseLimit}`" subtitle="Instancias usadas" logo="/logos/cassandra.svg" cardColor="#1287B1" />
    <StatCard title="SQL SERVER" :value="`${countByEngine('SQL Server')} / ${databaseLimit}`" subtitle="Instancias usadas" logo="/logos/sqlserver.svg" cardColor="#8B5CF6" />
    <StatCard title="REDIS" :value="`${countByEngine('Redis')} / ${databaseLimit}`" subtitle="Instancias usadas" logo="/logos/redis.svg" cardColor="#DC382D" />
    </div>
</section>

<section class="instances-section reveal-on-scroll">
    <div class="toolbar">
    <div class="toolbar-field" style="flex:1">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        <input v-model="searchTerm" placeholder="Buscar por nombre..." />
    </div>
    <select v-model="filterEngine" class="toolbar-select">
        <option value="">Todos nuestros gestores de bases de datos</option>
        <option>MySQL</option>
        <option>PostgreSQL</option>
        <option>MongoDB</option>
        <option>Cassandra</option>
        <option>SQL Server</option>
        <option>Redis</option>
    </select>
    </div>

    <div class="db-table-container">
    <table class="db-table">
        <thead>
        <tr>
            <th>Estado</th>
            <th>Nombre</th>
            <th>Gestor</th>
            <th>Host</th>
            <th>Puerto</th>
            <th>Usuario</th>
            <th>Contrase√±a</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="db in filteredDbs" :key="db.id">
            <td><span :class="'badge '+(db.status==='Activo'?'badge-success':'')">{{ db.status }}</span></td>
            <td>
                <div class="password-wrapper">
                    <span class="password">{{ db.name }}</span>
                    <button 
                      class="icon-btn" 
                      @click="copyToClipboard(db.name)" 
                      title="Copiar nombre"
                      aria-label="Copiar nombre"
                    >
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    </button>
                </div>
            </td>
            <td>{{ db.engine }}</td>
            <td>
                <div class="password-wrapper">
                    <span class="host">{{ db.host }}</span>
                    <button 
                      class="icon-btn" 
                      @click="copyToClipboard(db.host)" 
                      title="Copiar host"
                      aria-label="Copiar host"
                    >
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    </button>
                </div>
            </td>
            <td>{{ db.port }}</td>
            <td>
                <div class="password-wrapper">
                    <span class="password">{{ db.username || 'N/A' }}</span>
                    <button 
                      class="icon-btn" 
                      @click="copyToClipboard(db.username)" 
                      :disabled="!db.username"
                      title="Copiar usuario"
                      aria-label="Copiar usuario"
                    >
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    </button>
                </div>
            </td>
            <td>
                <div class="password-wrapper">
                    <span class="password">{{ db.passwordVisible ? db.password : masked(db.password) }}</span>
                        <button 
                          class="icon-btn" 
                          @click="copyPasswordAndHide(db)" 
                          :disabled="!db.passwordVisible"
                          :title="!db.passwordVisible ? 'La contrase√±a ya fue copiada. Usa \'Ver\' para obtener una nueva.' : 'Copiar contrase√±a'"
                          aria-label="Copiar contrase√±a"
                        >
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        </button>
                </div>
            </td>
            <td>
                <div class="actions">
                    <button 
                      class="action-btn" 
                      @click="viewCredentials(db)" 
                      title="‚ö†Ô∏è Al ver las credenciales se generar√° una nueva contrase√±a"
                    >
                      Ver
                    </button>
                    <button class="action-btn delete" @click="removeDatabase(db)" title="Eliminar base de datos">Borrar</button>
                </div>
            </td>
        </tr>
        <tr v-if="filteredDbs.length === 0">
            <td colspan="6" class="empty-state">No se encontraron bases de datos</td>
        </tr>
        </tbody>
    </table>
    </div>
</section>

<!-- Modal Ver Credenciales -->
<div v-if="showCredentials" class="modal-overlay" @click.self="closeCredentials">
    <div class="modal-content-glass credentials-modal">
        <button class="modal-close-btn" @click="closeCredentials">√ó</button>
        
        <div class="step-content">
            <h2 class="modal-title">üîë Credenciales de {{ selectedDb?.name || 'Base de Datos' }}</h2>
            <p class="modal-subtitle">Utiliza estos datos para conectarte a tu base de datos</p>
            
            <div class="credentials-container">
                <!-- Host -->
                <div class="credential-item">
                    <span class="credential-label">üåê Host:</span>
                    <div class="credential-value-wrapper">
                        <span class="credential-value">{{ currentCredentials?.host || 'N/A' }}</span>
                        <button class="copy-btn" @click="copyToClipboard(currentCredentials?.host)" title="Copiar host">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Puerto -->
                <div class="credential-item">
                    <span class="credential-label">üîå Puerto:</span>
                    <div class="credential-value-wrapper">
                        <span class="credential-value">{{ currentCredentials?.port || 'N/A' }}</span>
                        <button class="copy-btn" @click="copyToClipboard(currentCredentials?.port)" title="Copiar puerto">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Usuario -->
                <div class="credential-item">
                    <span class="credential-label">üë§ Usuario:</span>
                    <div class="credential-value-wrapper">
                        <span class="credential-value">{{ currentCredentials?.username || 'N/A' }}</span>
                        <button class="copy-btn" @click="copyToClipboard(currentCredentials?.username)" title="Copiar usuario">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Contrase√±a -->
                <div class="credential-item credential-password">
                    <span class="credential-label">üîê Contrase√±a:</span>
                    <div class="credential-value-wrapper">
                        <span class="credential-value password-value">{{ currentCredentials?.password || 'N/A' }}</span>
                        <button class="copy-btn" @click="copyToClipboard(currentCredentials?.password)" title="Copiar contrase√±a">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Base de datos -->
                <div class="credential-item">
                    <span class="credential-label">üíæ Base de datos:</span>
                    <div class="credential-value-wrapper">
                        <span class="credential-value">{{ currentCredentials?.databaseName || selectedDb?.name || 'N/A' }}</span>
                        <button class="copy-btn" @click="copyToClipboard(currentCredentials?.databaseName || selectedDb?.name)" title="Copiar nombre de base de datos">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Advertencia importante -->
            <div class="warning-box">
                <span class="warning-icon">‚ö†Ô∏è</span>
                <div class="warning-content">
                    <p class="warning-title">IMPORTANTE:</p>
                    <p class="warning-text">Esta contrase√±a ha sido regenerada. Actualiza tus aplicaciones con las nuevas credenciales.</p>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-outline" @click="closeCredentials">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear -->
<div v-if="showCreate" class="modal-overlay" @click.self="showCreate=false">
    <div class="modal-content-glass">
    <button class="modal-close-btn" @click="showCreate=false">√ó</button>
    
    <!-- Paso 1: Selecci√≥n de Motor -->
    <div v-if="createStep === 1" class="step-content">
        <h2 class="modal-title">Selecciona el Motor de Base de Datos</h2>
        <p class="modal-subtitle">Elige el tipo de base de datos que deseas crear</p>
        
        <div class="engine-grid">
        <div 
            v-for="engine in engineOptions" 
            :key="engine.name"
            class="engine-card"
            :class="{ 
              'selected': newDb.engine === engine.name,
              'disabled': engine.name !== 'MySQL'
            }"
            :style="{ '--engine-color': engine.color }"
            @click="selectEngine(engine.name)"
        >
            <div class="engine-icon">
            <img :src="engine.logo" :alt="engine.name" />
            </div>
            <h3>{{ engine.name }}</h3>
            <p class="engine-desc">{{ engine.description }}</p>
            <div class="engine-meta">
            <span v-if="engine.name === 'MySQL'" class="badge-available">‚úì Disponible</span>
            <span v-else class="badge-coming-soon">üîß En proceso</span>
            </div>
        </div>
        </div>
    </div>

    <!-- Paso 2: Configuraci√≥n -->
    <div v-if="createStep === 2" class="step-content">
        <button type="button" class="btn-back" @click="createStep = 1">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Volver
        </button>

        <h2 class="modal-title">Configuraci√≥n de {{ newDb.engine }}</h2>
        <p class="modal-subtitle">Define el nombre de tu instancia</p>

        <form class="modal-form" @submit.prevent="createDb">
        <div class="form-group">
            <label>Nombre de la Base de Datos</label>
            <input 
            v-model="newDb.name" 
            required 
            placeholder="mi_base_datos"
            pattern="[a-zA-Z0-9_]+"
            title="Solo letras, n√∫meros y guiones bajos"
            />
            <small class="form-hint">Solo se permiten letras, n√∫meros y guiones bajos</small>
        </div>

        <div class="connection-preview">
            <h4>Vista Previa de Conexi√≥n</h4>
            <div class="preview-item">
            <span class="preview-label">Host:</span>
            <span class="preview-value">{{ getEngineHost(newDb.engine) }}</span>
            </div>
            <div class="preview-item">
            <span class="preview-label">Puerto:</span>
            <span class="preview-value">{{ getEnginePort(newDb.engine) }}</span>
            </div>
            <div class="preview-item">
            <span class="preview-label">String de conexi√≥n:</span>
            <code class="preview-code">{{ getConnectionString(newDb.engine, newDb.name) }}</code>
            </div>
        </div>

        <div class="modal-actions">
            <button type="button" class="btn-outline" @click="createStep = 1">Atr√°s</button>
            <button type="submit" class="btn-primary">Crear Instancia</button>
        </div>
        </form>
    </div>
    </div>
</div>

</div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import StatCard from '../components/StatCard.vue'
import { showAlert } from '@/utils/notify'
import { createDatabase, getDatabaseCredentials, deleteDatabase, getAllDatabases, rotateCredentials, getDatabasesCount } from '@/services/databaseService'
import { showLoading, hideLoading } from '@/store/loading'
import { showAuthStatusModal } from '@/utils/authDebug'
import { debugToken } from '@/utils/tokenDebug'
import { logoutAndRedirect } from '@/services/authService'
import { getUserPlan, syncUserPlan } from '@/services/subscriptionService'
import { getDatabaseLimit, canCreateDatabase } from '@/config/plans'

const router = useRouter()
const searchTerm = ref('')
const filterEngine = ref('')
const databases = ref([])
const userPlan = ref(getUserPlan()) // Plan del usuario
const databaseLimit = ref(getDatabaseLimit(userPlan.value)) // L√≠mite seg√∫n el plan

const databasesCount = ref({
  mysql: 0,
  postgresql: 0,
  mongodb: 0,
  cassandra: 0,
  sqlserver: 0,
  redis: 0
})

const filteredDbs = computed(() => {
const term = searchTerm.value.toLowerCase()
const eng = filterEngine.value
return databases.value
    .filter(db => (eng ? db.engine === eng : true))
    .filter(db => (term ? db.name.toLowerCase().includes(term) : true))
})

const countByEngine = (eng) => {
  // Mapear nombres de motor a las claves del objeto count
  const engineMap = {
    'MySQL': 'mysql',
    'PostgreSQL': 'postgresql',
    'MongoDB': 'mongodb',
    'Cassandra': 'cassandra',
    'SQL Server': 'sqlserver',
    'Redis': 'redis'
  }
  
  const key = engineMap[eng]
  const apiCount = key ? databasesCount.value[key] || 0 : 0
  
  // Si el conteo de la API es 0, contar desde las bases de datos locales como fallback
  if (apiCount === 0 && databases.value.length > 0) {
    const localCount = databases.value.filter(db => db.engine === eng).length
    console.log(`üîÑ Usando conteo local para ${eng}: ${localCount}`)
    return localCount
  }
  
  return apiCount
}

const showCreate = ref(false)
const createStep = ref(1)
const newDb = ref({ name: '', engine: '' })

// Estado del modal de credenciales
const showCredentials = ref(false)
const selectedDb = ref(null)
const currentCredentials = ref(null)

// Opciones de motores con metadata
const engineOptions = ref([
  {
    name: 'MySQL',
    description: 'Base de datos relacional de c√≥digo abierto',
    logo: '/logos/mysql.svg',
    defaultPort: 3306,
    host: 'mysql.dbflow.dev',
    connectionString: 'mysql://username:password@mysql.dbflow.dev:3306/{dbname}',
    color: '#00758F'
  },
  {
    name: 'PostgreSQL',
    description: 'Sistema de gesti√≥n de bases de datos relacional',
    logo: '/logos/postgresql.svg',
    defaultPort: 5432,
    host: 'postgres.dbflow.dev',
    connectionString: 'postgresql://username:password@postgres.dbflow.dev:5432/{dbname}',
    color: '#336791'
  },
  {
    name: 'MongoDB',
    description: 'Base de datos NoSQL orientada a documentos',
    logo: '/logos/mongodb.svg',
    defaultPort: 27017,
    host: 'mongo.dbflow.dev',
    connectionString: 'mongodb://username:password@mongo.dbflow.dev:27017/{dbname}',
    color: '#47A248'
  },
  {
    name: 'Cassandra',
    description: 'Base de datos distribuida altamente escalable',
    logo: '/logos/cassandra.svg',
    defaultPort: 9042,
    host: 'cassandra.dbflow.dev',
    connectionString: 'cassandra://cassandra.dbflow.dev:9042/{dbname}',
    color: '#1287B1'
  },
  {
    name: 'SQL Server',
    description: 'Sistema de gesti√≥n de bases de datos de Microsoft',
    logo: '/logos/sqlserver.svg',
    defaultPort: 1433,
    host: 'sqlserver.dbflow.dev',
    connectionString: 'Server=sqlserver.dbflow.dev,1433;Database={dbname};User Id=username;Password=password;',
    color: '#8B5CF6'
  },
  {
    name: 'Redis',
    description: 'Almac√©n de estructura de datos en memoria',
    logo: '/logos/redis.svg',
    defaultPort: 6379,
    host: 'redis.dbflow.dev',
    connectionString: 'redis://username:password@redis.dbflow.dev:6379',
    color: '#DC382D'
  }
])

const selectEngine = (engineName) => {
  // Solo MySQL est√° disponible por ahora
  if (engineName !== 'MySQL') {
    showAlert({ 
      icon: 'info', 
      title: 'Pr√≥ximamente', 
      text: `${engineName} estar√° disponible pr√≥ximamente. Por ahora solo MySQL est√° habilitado.`,
      confirmText: 'Entendido'
    })
    return
  }
  
  newDb.value.engine = engineName
  createStep.value = 2
}

const getEngineHost = (engineName) => {
  const engine = engineOptions.value.find(e => e.name === engineName)
  return engine?.host || 'db.dbflow.dev'
}

const getEnginePort = (engineName) => {
  const engine = engineOptions.value.find(e => e.name === engineName)
  return engine?.defaultPort || 8000
}

const getConnectionString = (engineName, dbName) => {
  const engine = engineOptions.value.find(e => e.name === engineName)
  if (!engine) return ''
  return engine.connectionString.replace('{dbname}', dbName || 'database_name')
}

// Password masking
const masked = (pwd = '') => '‚Ä¢'.repeat(Math.max(8, Math.min(12, pwd.length || 8)))

const copyPassword = async (pwd = '') => {
    try {
        await navigator.clipboard.writeText(pwd)
        await showAlert({ icon: 'success', title: 'Copiada', text: 'Contrase√±a copiada al portapapeles', autoClose: 1200 })
    } catch (e) {
        console.warn('Clipboard API no disponible, usando fallback', e)
        const textarea = document.createElement('textarea')
        textarea.value = pwd
        document.body.appendChild(textarea)
        textarea.select()
        document.execCommand('copy')
        document.body.removeChild(textarea)
        await showAlert({ icon: 'success', title: 'Copiada', text: 'Contrase√±a copiada', autoClose: 1200 })
    }
}

// Copiar contrase√±a y ocultarla permanentemente
const copyPasswordAndHide = async (db) => {
    // Si la contrase√±a no est√° visible, mostrar advertencia
    if (!db.passwordVisible) {
        await showAlert({ 
            icon: 'warning', 
            title: 'Contrase√±a no disponible', 
            text: 'La contrase√±a ya fue copiada anteriormente. Usa el bot√≥n "Ver" para obtener una nueva contrase√±a.',
            confirmText: 'Entendido'
        })
        return
    }
    
    // Copiar la contrase√±a
    try {
        await navigator.clipboard.writeText(db.password)
        await showAlert({ 
            icon: 'success', 
            title: 'Copiada', 
            text: 'Contrase√±a copiada. Por seguridad, ahora est√° oculta permanentemente. Usa "Ver" para obtener una nueva.',
            autoClose: 2500 
        })
        
        // Ocultar la contrase√±a permanentemente despu√©s de copiarla
        db.passwordVisible = false
        
        // Guardar en localStorage que esta contrase√±a ya fue copiada
        const hiddenPasswords = JSON.parse(localStorage.getItem('hiddenPasswords') || '[]')
        if (!hiddenPasswords.includes(db.id)) {
            hiddenPasswords.push(db.id)
            localStorage.setItem('hiddenPasswords', JSON.stringify(hiddenPasswords))
        }
    } catch (e) {
        console.warn('Clipboard API no disponible, usando fallback', e)
        const textarea = document.createElement('textarea')
        textarea.value = db.password
        document.body.appendChild(textarea)
        textarea.select()
        document.execCommand('copy')
        document.body.removeChild(textarea)
        await showAlert({ 
            icon: 'success', 
            title: 'Copiada', 
            text: 'Contrase√±a copiada. Por seguridad, ahora est√° oculta permanentemente.',
            autoClose: 2500 
        })
        
        // Ocultar la contrase√±a permanentemente despu√©s de copiarla
        db.passwordVisible = false
        
        // Guardar en localStorage que esta contrase√±a ya fue copiada
        const hiddenPasswords = JSON.parse(localStorage.getItem('hiddenPasswords') || '[]')
        if (!hiddenPasswords.includes(db.id)) {
            hiddenPasswords.push(db.id)
            localStorage.setItem('hiddenPasswords', JSON.stringify(hiddenPasswords))
        }
    }
}

const openCreateModal = () => {
  newDb.value = { name: '', engine: '' }
  createStep.value = 1
  showCreate.value = true
}

// Funci√≥n de debug para verificar autenticaci√≥n
const debugAuth = () => {
  // Mostrar el modal profesional de estado de autenticaci√≥n
  showAuthStatusModal();
}

const createDb = async () => {
  if (!newDb.value.name || !newDb.value.engine) {
    await showAlert({ 
      icon: 'error', 
      title: 'Campos incompletos', 
      text: 'Por favor completa todos los campos',
      confirmText: 'Entendido'
    })
    return
  }

  // Validar l√≠mite del plan antes de crear
  const currentCount = countByEngine(newDb.value.engine)
  const canCreate = canCreateDatabase(userPlan.value, currentCount)
  
  if (!canCreate) {
    const planName = userPlan.value === 'free' ? 'Gratuito' : 
                     userPlan.value === 'intermediate' ? 'Intermedio' : 'Avanzado'
    
    await showAlert({ 
      icon: 'warning', 
      title: '‚ö†Ô∏è L√≠mite alcanzado', 
      text: `Has alcanzado el l√≠mite de ${databaseLimit.value} bases de datos de ${newDb.value.engine} para tu plan ${planName}.\n\n¬øDeseas actualizar tu plan para obtener m√°s bases de datos?`,
      confirmText: 'Ver planes',
      showCancel: true,
      cancelText: 'Cancelar'
    }).then((result) => {
      if (result && result.isConfirmed) {
        router.push({ name: 'Subscription' })
      }
    })
    return
  }

  try {
    showLoading('Creando base de datos...')
    
    // Llamar a la API de MySQL con todos los campos requeridos
    const response = await createDatabase({
      databaseName: newDb.value.name,
      engine: newDb.value.engine || 'MySQL' // Asegurar que siempre tenga engine
    })
    
    console.log('Base de datos creada:', response)
    
    // Recargar las bases de datos y el conteo
    await loadDatabases()
    await loadDatabasesCount()
    
    // Resetear el formulario
    newDb.value = { name: '', engine: '' }
    createStep.value = 1
    showCreate.value = false
    
    await showAlert({ 
      icon: 'success', 
      title: '¬°Base de datos creada!', 
      text: `La base de datos "${response.databaseName}" ha sido creada exitosamente`,
      confirmText: 'Perfecto'
    })
  } catch (error) {
    console.error('Error al crear base de datos:', error)
    console.error('Response data:', error.response?.data)
    console.error('Response status:', error.response?.status)
    
    // Si es un error 400, el payload es inv√°lido
    if (error.response?.status === 400) {
      const errorDetail = error.response?.data?.errors 
        || error.response?.data?.message 
        || error.response?.data?.title
        || 'El servidor rechaz√≥ la petici√≥n';
      
      let errorMessage = '‚ùå Error 400 - Bad Request\n\n';
      
      if (typeof errorDetail === 'object') {
        errorMessage += 'Detalles del error:\n';
        Object.keys(errorDetail).forEach(key => {
          errorMessage += `‚Ä¢ ${key}: ${JSON.stringify(errorDetail[key])}\n`;
        });
      } else {
        errorMessage += errorDetail;
      }
      
      errorMessage += '\n\nVerifica en la consola para m√°s detalles.';
      
      await showAlert({ 
        icon: 'error', 
        title: 'Petici√≥n Inv√°lida (400)', 
        text: errorMessage,
        confirmText: 'Entendido'
      })
      return
    }
    
    // Si es un error 405, el m√©todo no est√° permitido (problema del backend)
    if (error.response?.status === 405) {
      await showAlert({ 
        icon: 'error', 
        title: 'M√©todo no permitido (405)', 
        text: 'El backend no acepta peticiones POST a este endpoint.\n\nVerifica:\n‚Ä¢ Que el endpoint /api/Databases/MySQL acepte POST\n‚Ä¢ Que CORS est√© configurado correctamente\n‚Ä¢ Que el backend est√© corriendo en el puerto 5030',
        confirmText: 'Entendido'
      })
      return
    }
    
    // Si es un error 401, el token expir√≥ - cerrar sesi√≥n autom√°ticamente
    if (error.response?.status === 401) {
      console.warn('‚ö†Ô∏è Error 401 - Token expirado');
      
      // Mostrar mensaje y cerrar sesi√≥n autom√°ticamente
      await showAlert({ 
        icon: 'warning', 
        title: '‚ö†Ô∏è Sesi√≥n Expirada', 
        text: 'Tu sesi√≥n ha expirado. Ser√°s redirigido al inicio de sesi√≥n.',
        confirmText: 'Entendido',
        autoClose: 3000  // Se cierra autom√°ticamente despu√©s de 3 segundos
      })
      
      console.log('üö™ Cerrando sesi√≥n autom√°ticamente...');
      
      // Cerrar sesi√≥n y redirigir
      await logoutAndRedirect(router)
      
      return
    }
    
    const errorMessage = error.response?.data?.message 
      || error.response?.data?.title
      || error.response?.data?.errors
      || error.message
      || 'Error al crear la base de datos'
    
    await showAlert({ 
      icon: 'error', 
      title: `Error al crear base de datos (${error.response?.status || 'RED'})`, 
      text: typeof errorMessage === 'object' ? JSON.stringify(errorMessage) : errorMessage,
      confirmText: 'Entendido'
    })
  } finally {
    hideLoading()
  }
}

// Cargar bases de datos desde la API
const loadDatabases = async () => {
  try {
    showLoading('Cargando bases de datos...')
    
    console.log('üì° Intentando cargar bases de datos...');
    
    const data = await getAllDatabases()
    
    console.log('üì• Bases de datos recibidas del backend:', data)
    
    // Obtener las contrase√±as que ya fueron copiadas (ocultas permanentemente)
    const hiddenPasswords = JSON.parse(localStorage.getItem('hiddenPasswords') || '[]')
    
    // Solo actualizar si hay datos
    if (data && Array.isArray(data)) {
      // Mapear la respuesta de la API al formato esperado
      databases.value = data.map(db => ({
        id: db.id,
        name: db.databaseName || db.name,
        engine: db.engine || 'MySQL', // Usar el engine de la API
        host: db.host || 'mysql.dbflow.dev',
        port: db.port || 3306,
        status: db.status || 'Activo',
        username: db.username,
        password: db.password || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
        // Si la contrase√±a ya fue copiada antes, mantenerla oculta
        passwordVisible: !hiddenPasswords.includes(db.id)
      }))
      
      console.log('‚úÖ Bases de datos mapeadas:', databases.value)
      console.log('üìä Total de bases de datos:', databases.value.length)
      
      // Contar por motor
      const countByEngineLocal = databases.value.reduce((acc, db) => {
        acc[db.engine] = (acc[db.engine] || 0) + 1
        return acc
      }, {})
      console.log('üìä Conteo local por motor:', countByEngineLocal)
    }
  } catch (error) {
    console.error('‚ùå Error al cargar bases de datos:', error)
    console.error('‚ùå Response:', error.response?.data)
    console.error('‚ùå Status:', error.response?.status)
    
    // Ocultar loading inmediatamente
    hideLoading()
    
    // Si es un error 401, verificar si acabamos de iniciar sesi√≥n
    if (error.response?.status === 401) {
      console.warn('‚ö†Ô∏è Error 401 al cargar bases de datos');
      
      // Verificar cu√°nto tiempo ha pasado desde el login
      const loginTime = localStorage.getItem('login_time');
      const now = Date.now();
      const timeSinceLogin = loginTime ? (now - parseInt(loginTime)) : Infinity;
      
      // Si acabamos de iniciar sesi√≥n (menos de 10 segundos), no cerrar sesi√≥n a√∫n
      if (timeSinceLogin < 10000) {
        console.log('‚è∞ Inicio de sesi√≥n reciente, no cerrando sesi√≥n autom√°ticamente');
        console.log('üìã Mostrando mensaje de error en lugar de cerrar sesi√≥n');
        
        await showAlert({
          icon: 'error',
          title: '‚ùå Error de Configuraci√≥n del Backend',
          text: 'El backend est√° rechazando el token de autenticaci√≥n.\n\nPosibles causas:\n‚Ä¢ CORS no configurado correctamente\n‚Ä¢ Token no incluye userId en los claims\n‚Ä¢ Backend no permite peticiones desde este dominio\n\nContacta al equipo de backend con el archivo BACKEND_CONFIG_REQUIRED.md',
          confirmText: 'Entendido'
        });
        
        // No hacer return, continuar para que hideLoading se ejecute
      } else {
        // Si pas√≥ m√°s tiempo, cerrar sesi√≥n autom√°ticamente
        console.warn('‚ö†Ô∏è Token expirado - cerrando sesi√≥n');
        
        await showAlert({ 
          icon: 'warning', 
          title: '‚ö†Ô∏è Sesi√≥n Expirada', 
          text: 'Tu sesi√≥n ha expirado. Ser√°s redirigido al inicio de sesi√≥n.',
          confirmText: 'Entendido',
          autoClose: 3000
        })
        
        await logoutAndRedirect(router)
        return
      }
    }
    
    // Mantener la lista vac√≠a si falla la carga
  } finally {
    hideLoading()
  }
}

// Cargar el conteo de bases de datos
const loadDatabasesCount = async () => {
  try {
    const count = await getDatabasesCount()
    console.log('üìä Conteo de bases de datos recibido:', count)
    console.log('üìä Tipo de respuesta:', typeof count)
    console.log('üìä Claves de la respuesta:', count ? Object.keys(count) : 'null')
    
    // Actualizar el conteo - manejar diferentes formatos de respuesta
    if (count) {
      databasesCount.value = {
        mysql: count.mysql || count.MySQL || count.Mysql || 0,
        postgresql: count.postgresql || count.PostgreSQL || count.Postgresql || 0,
        mongodb: count.mongodb || count.MongoDB || count.Mongodb || 0,
        cassandra: count.cassandra || count.Cassandra || 0,
        sqlserver: count.sqlserver || count.sqlServer || count.SQLServer || count['SQL Server'] || 0,
        redis: count.redis || count.Redis || 0
      }
      console.log('‚úÖ Conteo actualizado:', databasesCount.value)
    }
  } catch (error) {
    console.error('‚ùå Error al cargar conteo de bases de datos:', error)
    console.error('‚ùå Detalles del error:', error.response?.data || error.message)
    // Mantener el conteo en 0 si falla
  }
}

// Eliminar base de datos
const removeDatabase = async (db) => {
  const result = await showAlert({ 
    icon: 'warning', 
    title: '¬øEliminar base de datos?', 
    text: `¬øEst√°s seguro de eliminar la base de datos "${db.name}"? Esta acci√≥n no se puede deshacer.`,
    confirmText: 'S√≠, eliminar',
    showCancel: true,
    cancelText: 'Cancelar'
  })
  
  // Verificar si el usuario confirm√≥ (isConfirmed === true)
  if (!result || !result.isConfirmed) {
    return
  }
  
  try {
    showLoading('Eliminando base de datos...')
    await deleteDatabase(db.id)
    
    // Limpiar el localStorage de contrase√±as ocultas para esta BD
    const hiddenPasswords = JSON.parse(localStorage.getItem('hiddenPasswords') || '[]')
    const updatedHidden = hiddenPasswords.filter(id => id !== db.id)
    localStorage.setItem('hiddenPasswords', JSON.stringify(updatedHidden))
    
    // Recargar las bases de datos y el conteo
    await loadDatabases()
    await loadDatabasesCount()
    
    await showAlert({ 
      icon: 'success', 
      title: '¬°Base de datos eliminada!', 
      text: `La base de datos "${db.name}" ha sido eliminada exitosamente`,
      confirmText: 'Entendido'
    })
  } catch (error) {
    console.error('Error al eliminar base de datos:', error)
    await showAlert({ 
      icon: 'error', 
      title: 'Error al eliminar', 
      text: error.response?.data?.message || 'Error al eliminar la base de datos',
      confirmText: 'Entendido'
    })
  } finally {
    hideLoading()
  }
}

// Ver credenciales de una base de datos
const viewCredentials = async (db) => {
  // Advertir al usuario que se van a rotar las credenciales
  console.log('üöÄ Iniciando viewCredentials para:', db);
  
  const confirmResult = await showAlert({
    icon: 'info',
    title: '‚ö†Ô∏è Nota Importante',
    text: 'Al ver las credenciales, se generar√° una nueva contrase√±a. ¬øDeseas continuar?',
    showCancel: true,
    confirmText: 'S√≠, continuar'
  });

  console.log('üìã Resultado de confirmaci√≥n:', confirmResult);

  if (!confirmResult?.isConfirmed) {
    console.log('‚ùå Usuario cancel√≥ la operaci√≥n');
    return;
  }

  try {
    console.log('‚úÖ Usuario confirm√≥, mostrando loading...');
    showLoading('Generando nuevas credenciales...')
    
    console.log('üîç Solicitando credenciales para DB:', db)
    
    const credentials = await getDatabaseCredentials(db.id)
    
    console.log('‚úÖ Credenciales recibidas:', credentials)
    
    // Actualizar el usuario en la base de datos local, pero NO marcar la contrase√±a como visible
    // La contrase√±a solo se ver√° en el modal, no en la tabla
    const dbIndex = databases.value.findIndex(d => d.id === db.id)
    if (dbIndex !== -1) {
      databases.value[dbIndex].password = credentials.password
      databases.value[dbIndex].username = credentials.username
      // NO actualizar passwordVisible - mantener la contrase√±a oculta en la tabla
    }
    
    // Guardar las credenciales y la DB seleccionada
    currentCredentials.value = credentials
    selectedDb.value = db
    
    // Cerrar loading y mostrar el modal
    hideLoading();
    showCredentials.value = true
    
    console.log('‚úÖ Modal de credenciales abierto');
  } catch (error) {
    console.error('‚ùå Error al obtener credenciales:', error)
    console.error('Response status:', error.response?.status)
    console.error('Response data:', error.response?.data)
    
    let errorMessage = 'Error al obtener credenciales';
    
    if (error.response?.status === 400) {
      const errorDetail = error.response?.data?.errors || error.response?.data?.message || error.response?.data;
      errorMessage = '‚ùå Error 400 - Bad Request\n\n';
      
      if (typeof errorDetail === 'object') {
        errorMessage += 'El servidor rechaz√≥ la petici√≥n:\n';
        Object.keys(errorDetail).forEach(key => {
          errorMessage += `‚Ä¢ ${key}: ${JSON.stringify(errorDetail[key])}\n`;
        });
      } else {
        errorMessage += errorDetail;
      }
    } else if (error.response?.status === 404) {
      errorMessage = 'No se encontr√≥ la base de datos.\n\nPuede que haya sido eliminada.';
    } else if (error.response?.status === 403) {
      errorMessage = 'No tienes permisos para acceder a estas credenciales.';
    } else {
      errorMessage = error.response?.data?.message || error.message || 'Error desconocido';
    }
    
    await showAlert({ 
      icon: 'error', 
      title: 'Error al obtener credenciales', 
      text: errorMessage,
      confirmText: 'Entendido'
    })
  } finally {
    console.log('üßπ Limpieza: cerrando loading en finally...');
    hideLoading()
    console.log('‚úÖ ViewCredentials completado');
  }
}

// Cerrar modal de credenciales
const closeCredentials = () => {
  showCredentials.value = false
  selectedDb.value = null
  currentCredentials.value = null
}

// Copiar al portapapeles
const copyToClipboard = async (text) => {
  if (!text) return
  
  try {
    await navigator.clipboard.writeText(String(text))
    await showAlert({ 
      icon: 'success', 
      title: 'Copiado', 
      text: 'Copiado al portapapeles',
      autoClose: 1200 
    })
  } catch (e) {
    console.warn('Clipboard API no disponible, usando fallback', e)
    const textarea = document.createElement('textarea')
    textarea.value = String(text)
    document.body.appendChild(textarea)
    textarea.select()
    document.execCommand('copy')
    document.body.removeChild(textarea)
    await showAlert({ 
      icon: 'success', 
      title: 'Copiado', 
      text: 'Copiado al portapapeles',
      autoClose: 1200 
    })
  }
}

// Rotar credenciales (generar nueva contrase√±a)
const rotateDbCredentials = async (db) => {
  const result = await showAlert({ 
    icon: 'info', 
    title: '¬øRotar credenciales?', 
    text: `¬øDeseas generar una nueva contrase√±a para "${db.name}"? La contrase√±a anterior dejar√° de funcionar.`,
    confirmText: 'S√≠, generar nueva',
    showCancel: true,
    cancelText: 'Cancelar'
  })
  
  // Verificar si el usuario confirm√≥ (isConfirmed === true)
  if (!result || !result.isConfirmed) {
    return
  }
  
  try {
    showLoading('Rotando credenciales...')
    const newCredentials = await rotateCredentials(db.id)
    
    console.log('Nuevas credenciales:', newCredentials)
    
    // Recargar las bases de datos para obtener la nueva contrase√±a
    await loadDatabases()
    
    await showAlert({ 
      icon: 'success', 
      title: '¬°Credenciales actualizadas!', 
      text: `Nueva contrase√±a generada para "${db.name}"`,
      confirmText: 'Entendido'
    })
  } catch (error) {
    console.error('Error al rotar credenciales:', error)
    await showAlert({ 
      icon: 'error', 
      title: 'Error', 
      text: error.response?.data?.message || 'Error al rotar credenciales',
      confirmText: 'Entendido'
    })
  } finally {
    hideLoading()
  }
}

onMounted(async () => {
  console.log('üöÄ DatabaseList montado');
  
  // Verificar si hay token antes de hacer cualquier cosa
  const token = localStorage.getItem('authToken');
  console.log('üîë Token presente:', token ? 'S√ç' : 'NO');
  
  if (!token) {
    console.warn('‚ö†Ô∏è No hay token, redirigiendo a login...');
    await showAlert({ 
      icon: 'warning', 
      title: '‚ö†Ô∏è Sesi√≥n No Iniciada', 
      text: 'Debes iniciar sesi√≥n para acceder a esta p√°gina.',
      confirmText: 'Ir a Login',
      autoClose: 2000
    });
    await router.push('/login');
    return;
  }
  
  // Sincronizar plan desde el backend
  await syncUserPlan()
  
  // Recargar plan actualizado
  userPlan.value = getUserPlan()
  databaseLimit.value = getDatabaseLimit(userPlan.value)
  
  console.log('üìã Plan actual del usuario:', userPlan.value)
  console.log('üî¢ L√≠mite de bases de datos:', databaseLimit.value)
  
  // Cargar bases de datos y conteo al montar el componente
  await loadDatabases()
  await loadDatabasesCount()
  
  // Observer para animaciones
  const observer = new IntersectionObserver(
    (entries) => {
    entries.forEach((entry) => {
        if (entry.isIntersecting) {
        entry.target.classList.add('is-visible')
        }
    })
    },
    { threshold: 0.1 }
  )
  const reveals = document.querySelectorAll('.reveal-on-scroll')
  reveals.forEach((el) => observer.observe(el))
})
</script>

<style scoped>
.dashboard-view {
width: 100%;
}

.view-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    color: white;
}

.view-header h1 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
}

.view-subtitle { color:#94a3b8; margin-top:6px; font-size:.95rem; }

.toolbar { display:flex; gap:12px; align-items:center; margin-bottom: 20px; flex-wrap: wrap; }
.toolbar-field { display:flex; align-items:center; gap:8px; background:#0f0f10; border:1px solid #222; color:#9aa0a6; padding:8px 12px; border-radius:10px; transition: border-color 0.2s; }
.toolbar-field:focus-within { border-color: #00bfff; }
.toolbar-field input { background:transparent; border:none; outline:none; color:#fff; min-width:220px; }
.toolbar-field svg { width:18px; height:18px; }
.toolbar-select { background:#0f0f10; border:1px solid #222; color:#fff; padding:8px 12px; border-radius:10px; cursor: pointer; transition: border-color 0.2s; }
.toolbar-select:hover { border-color: #444; }

.quota-section { margin-bottom: 40px; }
.quota-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 20px;
}

.instances-section {
    margin-bottom: 40px;
}

h3 {
    font-size: 0.85rem;
    font-weight: 600;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 24px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.db-table-container {
background: #0f0f10;
border: 1px solid rgba(255, 255, 255, 0.08);
border-radius: 12px;
overflow: hidden;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.db-table { width: 100%; border-collapse: collapse; }
.db-table th, .db-table td { padding: 12px 14px; text-align: left; }
.db-table thead th { background: rgba(255,255,255,0.03); font-size: .85rem; color: #cbd5e1; font-weight: 600; }
.db-table tbody tr { border-top: 1px solid rgba(255,255,255,0.06); }
.db-table tbody tr:hover { background: rgba(255,255,255,0.03); }

.password-wrapper { display: flex; align-items: center; gap: 8px; }
.password { font-family: monospace; letter-spacing: 1px; color: #e2e8f0; }
.icon-btn { background: transparent; border: 1px solid rgba(255,255,255,0.12); color: #9aa0a6; border-radius: 8px; padding: 6px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
.icon-btn:hover:not(:disabled) { border-color: rgba(255,255,255,0.3); color: #fff; }
.icon-btn:disabled { 
  opacity: 0.4; 
  cursor: not-allowed; 
  border-color: rgba(255,255,255,0.08);
}
.icon-btn svg { width: 18px; height: 18px; }

.badge { background: rgba(255,255,255,0.06); color:#ddd; border:1px solid rgba(255,255,255,0.12); padding:4px 10px; border-radius:999px; font-size:.8rem; white-space: nowrap; }
.badge-success { color:#22c55e; border-color: rgba(34,197,94,0.35); background: rgba(34,197,94,0.08); }
.host { color:#94a3b8; font-family: monospace; font-size: 0.9rem; }

.actions { display:flex; gap:8px; }
.action-btn { background: transparent; color:#e5e7eb; border:1px solid rgba(255,255,255,0.15); padding:6px 10px; border-radius:8px; cursor:pointer; font-size:.85rem; }
.action-btn:hover { border-color: rgba(255,255,255,0.35); }
.action-btn.delete { color:#f87171; border-color: rgba(248,113,113,0.35); }
.action-btn.delete:hover { border-color: rgba(248,113,113,0.6); background: rgba(248,113,113,0.06); }

.empty-state {
text-align: center;
color: #94a3b8;
padding: 60px 20px !important;
font-style: italic;
font-size: 0.95rem;
}

@media (max-width: 768px) {
.view-header { flex-direction: column; align-items: stretch; gap: 16px; }
.toolbar { flex-direction: column; width: 100%; }
.toolbar-field { width: 100%; }
.toolbar-field input { min-width: auto; width: 100%; }
.toolbar-select { width: 100%; }
.quota-grid { grid-template-columns: 1fr; }
}

/* ============================================
   MODAL DE CREACI√ìN - GLASSMORPHISM
   ============================================ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content-glass {
  background: rgba(15, 15, 16, 0.85);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  padding: 32px;
  max-width: 650px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  position: relative;
  animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}

/* Scrollbar personalizado para el modal */
.modal-content-glass::-webkit-scrollbar {
  width: 8px;
}

.modal-content-glass::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
}

.modal-content-glass::-webkit-scrollbar-thumb {
  background: rgba(0, 191, 255, 0.3);
  border-radius: 10px;
}

.modal-content-glass::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 191, 255, 0.5);
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-close-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: #fff;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.modal-close-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.2);
  transform: rotate(90deg);
}

.modal-title {
  font-size: 1.8rem;
  font-weight: 700;
  margin: 0 0 8px 0;
  color: #fff;
}

.modal-subtitle {
  color: #fff;
  margin: 0 0 32px 0;
  font-size: 1rem;
}

.step-content {
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* Grid de motores de BD */
.engine-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 28px;
}

.engine-card {
  background: rgba(255, 255, 255, 0.03);
  border: 2px solid rgba(255, 255, 255, 0.08);
  border-radius: 12px;
  padding: 14px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.engine-card::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, var(--engine-color, #00bfff) 0%, transparent 100%);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.engine-card:hover {
  border-color: var(--engine-color, rgba(0, 191, 255, 0.4));
  transform: translateY(-4px);
  box-shadow: 0 8px 24px var(--engine-color, rgba(0, 191, 255, 0.15));
}

.engine-card:hover::before {
  opacity: 0.15;
}

.engine-card.selected {
  border-color: var(--engine-color, #00bfff);
  background: linear-gradient(135deg, var(--engine-color, #00bfff) 0%, transparent 100%);
  box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.2), 0 0 20px var(--engine-color, rgba(0, 191, 255, 0.3));
}

.engine-card.selected::before {
  opacity: 0.2;
}

/* Tarjetas deshabilitadas */
.engine-card.disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.engine-card.disabled:hover {
  transform: translateY(-2px);
  border-color: rgba(255, 255, 255, 0.15);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.engine-card.disabled::before {
  opacity: 0 !important;
}

.engine-icon {
  width: 42px;
  height: 42px;
  margin: 0 auto 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  z-index: 1;
}

.engine-icon img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
}

.engine-card h3 {
  font-size: 0.95rem;
  font-weight: 600;
  margin: 0 0 6px 0;
  color: #fff;
  border: none;
  padding: 0;
  text-transform: none;
  letter-spacing: normal;
  position: relative;
  z-index: 1;
}

.engine-desc {
  font-size: 0.75rem;
  color: #94a3b8;
  margin: 0 0 10px 0;
  line-height: 1.3;
  position: relative;
  z-index: 1;
}

.engine-meta {
  font-size: 0.7rem;
  color: #64748b;
  font-family: monospace;
  position: relative;
  z-index: 1;
}

/* Badges de estado */
.badge-available {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  background: rgba(76, 175, 80, 0.2);
  color: #4caf50;
  font-size: 0.7rem;
  font-weight: 600;
  font-family: 'Roboto Mono', monospace;
}

.badge-coming-soon {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  background: rgba(255, 152, 0, 0.2);
  color: #ff9800;
  font-size: 0.7rem;
  font-weight: 600;
  font-family: 'Roboto Mono', monospace;
}

/* Formulario del paso 2 */
.modal-form {
  margin-top: 24px;
}

.form-group {
  margin-bottom: 24px;
}

.form-group label {
  display: block;
  font-size: 0.9rem;
  font-weight: 600;
  color: #cbd5e1;
  margin-bottom: 8px;
}

.form-group input,
.form-group select {
  width: 100%;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.12);
  color: #fff;
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #00bfff;
  background: rgba(255, 255, 255, 0.08);
  box-shadow: 0 0 0 4px rgba(0, 191, 255, 0.1);
}

.form-hint {
  display: block;
  margin-top: 6px;
  font-size: 0.8rem;
  color: #64748b;
}

/* Vista previa de conexi√≥n */
.connection-preview {
  background: rgba(0, 191, 255, 0.05);
  border: 1px solid rgba(0, 191, 255, 0.2);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
}

.connection-preview h4 {
  font-size: 0.9rem;
  font-weight: 600;
  color: #00bfff;
  margin: 0 0 16px 0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.preview-item {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
  gap: 16px;
}

.preview-item:last-child {
  margin-bottom: 0;
}

.preview-label {
  font-size: 0.85rem;
  color: #94a3b8;
  font-weight: 500;
  min-width: 140px;
}

.preview-value {
  font-size: 0.9rem;
  color: #e2e8f0;
  font-family: monospace;
  text-align: right;
}

.preview-code {
  font-size: 0.8rem;
  color: #00bfff;
  background: rgba(0, 0, 0, 0.3);
  padding: 8px 12px;
  border-radius: 6px;
  display: block;
  overflow-wrap: break-word;
  word-break: break-all;
  white-space: normal;
  flex: 1;
  line-height: 1.4;
}

/* Botones del modal */
.modal-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 32px;
}

.btn-primary,
.btn-outline {
  padding: 12px 24px;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}

.btn-primary {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 2px solid rgba(255, 255, 255, 0.3);
  color: #fff;
  font-weight: 600;
  font-family: 'Roboto Mono', monospace;
  box-shadow: 0 0 20px rgba(255, 255, 255, 0.2),
              0 0 40px rgba(255, 255, 255, 0.1);
}

.btn-primary:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
  box-shadow: 0 0 30px rgba(255, 255, 255, 0.4),
              0 0 60px rgba(255, 255, 255, 0.2),
              0 0 90px rgba(255, 255, 255, 0.1);
  color: #fff;
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.btn-debug {
  background: rgba(59, 130, 246, 0.1);
  border: 2px solid rgba(59, 130, 246, 0.3);
  color: #60a5fa;
  padding: 12px 24px;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Roboto Mono', monospace;
}

.btn-debug:hover {
  background: rgba(59, 130, 246, 0.2);
  border-color: rgba(59, 130, 246, 0.5);
  transform: translateY(-2px);
  box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
}

.btn-outline {
  background: transparent;
  color: #94a3b8;
  border: 1px solid rgba(255, 255, 255, 0.12);
}

.btn-outline:hover {
  border-color: rgba(255, 255, 255, 0.3);
  color: #fff;
}

.btn-back {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: transparent;
  border: 1px solid rgba(255, 255, 255, 0.12);
  color: #94a3b8;
  padding: 8px 16px;
  border-radius: 10px;
  font-size: 0.9rem;
  cursor: pointer;
  margin-bottom: 24px;
  transition: all 0.3s ease;
}

.btn-back:hover {
  border-color: rgba(255, 255, 255, 0.3);
  color: #fff;
}

.btn-back svg {
  width: 18px;
  height: 18px;
}

/* Responsive para el modal */
@media (max-width: 768px) {
  .modal-content-glass {
    padding: 24px;
  }

  .modal-title {
    font-size: 1.4rem;
  }

  .engine-grid {
    grid-template-columns: 1fr;
  }

  .preview-item {
    flex-direction: column;
    align-items: flex-start;
  }

  .preview-label {
    min-width: auto;
  }

  .preview-value {
    text-align: left;
  }

  .modal-actions {
    flex-direction: column-reverse;
  }

  .btn-primary,
  .btn-outline {
    width: 100%;
  }
  
  .credential-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .credential-value-wrapper {
    width: 100%;
    justify-content: space-between;
  }
  
  .credential-value {
    text-align: left;
  }
  
  .credential-label {
    min-width: auto;
  }
}

/* ============================================
   MODAL DE CREDENCIALES
   ============================================ */
.credentials-modal {
  max-width: 580px;
}

.credentials-container {
  background: rgba(15, 15, 17, 0.6);
  border: 1.5px solid rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.credential-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  margin-bottom: 8px;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 8px;
  border-left: 3px solid #00bfff;
  transition: all 0.2s ease;
}

.credential-item:last-child {
  margin-bottom: 0;
}

.credential-item:hover {
  background: rgba(255, 255, 255, 0.05);
}

.credential-password {
  background: rgba(0, 191, 255, 0.08);
  border: 1.5px solid rgba(0, 191, 255, 0.3);
  border-left: 3px solid #00bfff;
  box-shadow: 0 0 20px rgba(0, 191, 255, 0.15);
}

.credential-password:hover {
  background: rgba(0, 191, 255, 0.12);
  box-shadow: 0 0 25px rgba(0, 191, 255, 0.2);
}

.credential-label {
  color: #94a3b8;
  font-size: 0.85rem;
  font-weight: 600;
  min-width: 130px;
  letter-spacing: 0.3px;
}

.credential-password .credential-label {
  color: #00bfff;
  font-weight: 700;
}

.credential-value-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
  justify-content: flex-end;
}

.credential-value {
  color: #e2e8f0;
  font-size: 0.9rem;
  font-weight: 500;
  word-break: break-all;
  text-align: right;
  font-family: 'Roboto Mono', monospace;
}

.password-value {
  color: #ffffff;
  font-size: 0.95rem;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
}

.copy-btn {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.12);
  color: #94a3b8;
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.copy-btn:hover {
  background: rgba(0, 191, 255, 0.15);
  border-color: rgba(0, 191, 255, 0.4);
  color: #00bfff;
  box-shadow: 0 0 15px rgba(0, 191, 255, 0.2);
}

.copy-btn svg {
  width: 16px;
  height: 16px;
}

.warning-box {
  background: rgba(239, 68, 68, 0.1);
  border: 1.5px solid rgba(239, 68, 68, 0.3);
  border-radius: 10px;
  padding: 12px 14px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 24px;
}

.warning-icon {
  font-size: 1.1rem;
  line-height: 1;
  flex-shrink: 0;
}

.warning-content {
  flex: 1;
}

.warning-title {
  margin: 0 0 4px 0;
  color: #fff;
  font-weight: 700;
  font-size: 0.85rem;
  letter-spacing: 0.4px;
}

.warning-text {
  margin: 0;
  color: #fff;
  font-size: 0.8rem;
  line-height: 1.4;
}

</style>
